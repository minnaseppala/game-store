{% extends "base.html" %}
{% load bootstrap4 %}
{% load static %}

{% block javascript %}
<script>
  $(document).ready(function() {
    'use strict';
    $(window).on('message', function(event) {
      //Note that messages from all origins are accepted
      //Get data from sent message
      let message = event.originalEvent.data;
      message.gameId = {{ game.id }}

      if (message.messageType === 'SCORE'){ 
        $.ajax({
          url:'/ajax/score/',
          data: message,
          dataType: 'json'
        });
      }

    });
  });
  </script>
{% endblock %}

{% block content %}
<div class="container" style="min-height: 85vh;">

  <div class="row px-4">
    <h3>{{ game.title }}</h3><br/>
  </div>
  <div class="row px-4">
    <p>by {{ game.publisher.username }}</p>
  </div>
  <div class="row px-4">
    <p>Game description: {{ game.description }}</p>
  </div>

  {% if game.publisher != user and not purchased_game %}
    <div class="row px-4">
      <a href="{% url 'games:purchase' game_id=game.pk %}" title="purchase" class="btn btn-primary">
        <span>Purchase game!</span>
      </a>
    </div>
  {% elif user.is_authenticated and purchased_game or game.publisher == user %}
    <div class="row pt-2 pl-4 w-100">
      <iframe src="{{ game.url }}" style="height: 50vh; width: 180vw;"></iframe>
    </div>
    <div class="row px-4">
      <h3>High Scores</h3>
    <table class="table">
      <thead>
        <tr>
          <th scope="col">#</th>
          <th scope="col">Player</th>
          <th scope="col">Score</th>
        </tr>
      </thead>
      <tbody>
      {% for score in scores %}
      <tr>
        <th scope="row">{{forloop.counter}}</th>
        <td>{{score.player}}</td>
        <td>{{score.score}}</td>
      </tr>
      {% endfor %}
    </tbody>
    </div>
  {% endif %}

  {% if user.is_authenticated and game.publisher == user %}
    <div>
      <a href="{% url 'games:update' pk=game.pk %}" title="update" class="btn btn-simple">
        <span class="fa fa-pencil" aria-hidden="true"></span>
        <span class="icon-label">Edit game</span>
      </a>
      <a href="{% url 'games:delete' pk=game.pk %}" title="delete" class="btn btn-simple">
        <span class="fa fa-remove text-danger" aria-hidden="true"></span>
        <span class="text-danger icon-label">Delete</span>
      </a>
      <a href="{% url 'games:statistics' pk=game.pk %}" title="update" class="btn btn-simple">
        <span class="fa fa-table" aria-hidden="true"></span>
        <span class="icon-label">View sales data</span>
      </a>
    </div>
  {% endif %}

</div>
{% endblock %}